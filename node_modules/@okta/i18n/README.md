I18N
=======

The **i18n** module is the common place to store all Okta localization strings.

Localization strings are stored in *.properties* files in the [properties/](https://github.com/okta/npm/tree/master/i18n/properties) folder, and [published to the following formats](#distributed-files):
- [Properties](https://en.wikipedia.org/wiki/.properties)
- [RequireJs i18n bundle](http://requirejs.org/docs/api.html#i18n)
- [JSON](http://www.json.org/)

## Developer workflow

1. [Initial setup](#setup)
2. [Link your changes for local development](#link-your-changes-to-the-monolith)
3. [Update](#updating-existing-properties-files), or [create new properties files](#creating-a-new-properties-file)
  - [Update major version if making a breaking change (like deleting properties)](#breaking-changes)
4. [Merge through bacon](#bacon)
5. [Update i18n version in downstream projects](#update-i18n-version-in-downstream-projects)

## Translation workflow

1. [Initial setup](#setup)
2. [Generate diff](#generating-diffs)
  - [If new language, generate diff-all file](#adding-a-new-language)
3. [Send diff files to translation vendor](#send-diff-files-to-translation-vendor)
4. [Import translated diff files](#importing-diffs)
5. [Merge through bacon](#bacon)
6. [Update i18n version in downstream projects](#update-i18n-version-in-downstream-projects)

## Commands

| Command              | Description
| -------------------- | -----------
| **npm run link**     | Links i18n to okta-core for easier development
| **npm run diff**     | Generates diff file with all changes across tracked files [more](#generating-diffs)
| **npm run diff-all** | Generates diff file for new language [more](#adding-a-new-language)
| **npm run import**   | Imports translated diff file [more](#importing-diffs)<br />Requires **--file=/path/to/diff-{sha}_{languageCode}.properties**
| **npm test**         | Runs unit tests
| **npm run lint**     | Runs lint

## Topics

### General

<a id="setup"></a>
#### Setup

```bash
# 1. Clone the `npm` repo if you don't have it, and navigate to i18n
[okta]$ git clone git@github.com:okta/npm.git && cd npm/i18n

# 2. Install dependencies
[npm/i18n]$ npm install
```

<a id="distributed-files"></a>
#### Distributed files

The published **i18n** module contains a *dist/* folder with the exported formats:

```bash
node_modules/@okta/i18n/
  dist/
    json/
      enduser_ja.json
      enduser.json
      ...
    properties/
      enduser_ja.properties
      enduser.properties
      ...
    requirejs/
      ja/
        enduser.js
        ...
      enduser.js
      ...
```

<a id="bacon"></a>
#### Bacon

To commit, get the :rocket: and merge through the [i18n bacon board](http://bacon.trex.saasure.com/#!/commits/i18n).

<a id="update-i18n-version-in-downstream-projects"></a>
#### Update i18n version in downstream projects

1. Wait for the master branch to finish all bacon test suites

    When your topic branch is merged, a new bacon run is kicked off against the master branch. The master *publish* test suite will publish a beta prerelease version with your commit to the [internal npm registry](https://oktawiki.atlassian.net/wiki/display/eng/Using+the+Okta+internal+NPM+registry).

2. Promote the master branch artifact.

    In bacon, click the [hamburger button](https://en.wikipedia.org/wiki/Hamburger_button) that's next to the merge button in the **master** run that was kicked off after merging your topic branch. Then choose **Promote artifact**. If you do not have the **Promote artifact** link, talk to eng-prod.

3. Visit the [artifact promotion](http://bacon.trex.saasure.com/#!/reports/artifact_promotion/all) page and wait for the status of your i18n artifact to be **PROMOTED**.

4. If you've made a non-breaking change, you're done! It will automatically be included the next time you run an `npm install` in the various okta-core modules.

5. If your change is breaking and you had to increment the i18n [major version](http://semver.org/), you'll need to update okta-core with your changes:

    - Find the release i18n version that you just promoted

        ```bash
        # The last release version will be the one you want, i.e. 2.0.0
        $ npm view @okta/i18n versions
        ```

    - Update version in all affected downstream modules. In okta-core, use the [install-with-shrinkwrap](https://github.com/okta/npm/tree/master/install-with-shrinkwrap#install-with-shrinkwrap) package to generate the right *npm-shrinkwrap.json* file in both *clients/admin* and the root *okta-core* folder:

        ```bash
        # OKTA-CORE

        # If you need to consume your changes in java land, update the root package
        [okta-core]$ npm run installsw @okta/i18n@2.0.0

        # If you need to consume your changes in client side javascript, update
        # clients/admin
        [okta-core/clients/admin]$ npm run installsw @okta/i18n@2.0.0

        # OTHER REPOS THAT DO NOT USE INSTALL-WITH-SHRINKWRAP

        # If you're updating a module that is not using install-with-shrinkwrap:
        [your-module]$ npm install -E @okta/i18n@2.0.0 --save
        ```

### Developer

<a id="link-your-changes-to-the-monolith"></a>
#### Link your changes to the monolith

> We are currently working on a more general approach that applies to any project

If you're working in [okta-core](https://github.com/okta/okta-core), we've written a command for easier development:

```bash
# Link i18n changes to okta-core
[i18n]$ npm run link
```

This sets up a [watch task](https://www.npmjs.com/package/grunt-contrib-watch) that triggers when changes are made to *.properties*:

1. Packages the [exported formats](#distributed-files)
2. Copies to original paths in okta-core

Once you've set up the link, your previous okta-core workflow will be the same - after the files have been copied by the watch task:
```bash
# Javascript
[okta-core]$ ant deploy.modified.ui.i18n

# Java (controller or jsp that consumes resources/i18n/*.properties)
[okta-core]$ ant smoke.tomcat deploy.modified.code start.tomcat.debug.async
```

**Note:** You must exit the link with **ctrl+c**.

<a id="updating-existing-properties-files"></a>
#### Updating existing .properties files

Localization strings are stored in *.properties* files in the [properties/](https://github.com/okta/npm/tree/master/i18n/properties) folder.

Two things to keep in mind when updating *.properties* files:
- Only modify the english source files. Language files are automatically generated from the [import process](#importing-diffs).
- Do not manually modify the *Last translated sha* line at the top of the source english files.

<a id="creating-a-new-properties-file"></a>
#### Creating a new .properties file

Add the new file to the *properties/* folder. It will automatically be exported to the [exported formats](#distributed-files) on the next publish.

If you want to add this file to the list of files to be translated, [read this](#adding-a-new-properties-file-for-translation).

<a id="breaking-changes"></a>
#### Breaking changes

Some downstream repos (like okta-core) will automatically pull in any non-breaking changes to release versions of the i18n module. Because of this, it is important to increment the i18n major version number whenever making any breaking changes - specifically, when you delete properties.

To update the major version number:

```bash
# Bumps package.json version number to next major version
[npm/i18n]$ npm version major
```

### Translations

<a id="generating-diffs"></a>
#### Generating diffs

> This is automated as part of the code-freeze process. At code-freeze, the diff is added to the weekly release notes, and an email is sent to the localization team.

```bash
# Generate diff-{current_sha}.properties file
[i18n]$ npm run diff
```

This command will generate a single *diff-{current_sha}.properties* file that contains all changes that have been made to the [tracked .properties files](#adding-a-new-properties-file-for-translation) since the last translation.

This file is sent to the translation vendor, and is composed of four sections:

1. **Translate** - new properties that need to be translated.
2. **Copy** - properties that have been renamed or duplicated across *.properties* files
3. **Delete** - properties that have been deleted
4. **Metadata** - additional metadata like the sha that this diff has been generated from

Sections 2-4 are commented out. This signals to the translators that they can ignore these sections when translating the file. The translator returns the file with the **Translate** section converted to the target language, where it can then be [imported](#importing-diffs).

<a id="adding-a-new-language"></a>
#### Adding a new language

Adding a new language is similar to the regular diff flow, except that the generated diff file includes **all** properties across **all** [tracked *.properties* files](#adding-a-new-properties-file-for-translation).

This must be done manually when we've decided to add a new language:

1. Checkout the sha that was used to generate the regular diff.

    > It is important to use the same sha because of how we internally track when to apply the diff.

2. Generate the *diffall-{current_sha}.properties* file

    ```bash
    # Generates a diffall-{current_sha}.properties file with all properties
    [i18n]$ npm run diff-all
    ```

<a id="adding-a-new-properties-file-for-translation"></a>
#### Adding a new .properties file for translation

> We currently only translate enduser facing properties

The list of tracked *.properties* files is stored in the *i18ndiff* target in the *Gruntfile.js*.

```javascript
// Gruntfile.js
'i18ndiff': {
  propertiesFiles: [
    'enduser',
    'login',
    // Add your new file here.
    // Note: No .properties extension is needed
    'new-properties-file'
  ]
}
```

<a id="send-diff-files-to-translation-vendor"></a>
#### Send diff files to translation vendor

We use [CloudWords](https://www.cloudwords.com/) to manage the translation process. For more information about this, check out the [Localization Home](https://oktawiki.atlassian.net/wiki/display/eng/Localization+Home) wiki page.

<a id="importing-diffs"></a>
#### Importing diffs

> The expected format for returned files is *diff-{sha}_{languageCode}.properties*
> i.e. diff-2345957d3811d621efc1070601ff5fda8f135710_ja.properties

Once the *diff.properties* files have been returned, run the `import` command for each file to import into your current branch.

```bash
# Run this for each translated diff file
[i18n]$ npm run import -- -file=/path/to/diff-{sha}_{language}.properties
```

Several things happen when this command is run:
- All changes described in the *diff.properties* file are applied to affected files. In fact, all language *.properties* files are re-generated at this time after the operations have been applied.
- The sha that this file was generated from is set as the *lastTranslatedSha* in the original, modified english files.
