define([
  'jquery',
  'underscore',
  'shared/views/tabs/Tabs',
  'shared/util/BaseRouter'
],
function ($, _, Tabs, BaseRouter) {

  /**
   * @class Okta.TabbedRouter
   * A router that generates a tabbed view where each tab maps to a route.
   * @extends Okta.Router
   */

  return BaseRouter.extend({

    constructor: function (options) {

      this.__hasDefaultRoute = false;

      var tabsWidget = this.__tabsWidget = new Tabs();
      tabsWidget.render();

      // keep a reference to the original "el" to append the whole tabs widget to
      var $el = $(options.el);

      // replace options.el with the content area in the tab widget
      options.el = tabsWidget.content();

      // attach the tab widget to the DOM only when ready
      // to make sure the original "el" is ready
      $(function () {
        $el.append(tabsWidget.el);
      });

      BaseRouter.call(this, options);
    },

    /**
     * Add a tab
     *
     * @param {String|Array} route The route or routes this tab handles
     * @param {String} method The method to invoke when the tab is selected
     * @param {String} label The label to display on the tab
     */
    tab: function (route, method, label) {
      var routes = _.isArray(route) ? route : [route];
      this.__addTab({routes: routes, method: method, label: label});
      return this;
    },

    /**
     * Internal method for adding a tab to the widget
     *
     * @param {Object} options Options hash
     * @param {Array} options.routes The routes this tab handles
     * @param {String} options.method The method to invoke when the tab is selected
     * @param {String} options.label The label to display on the tab
     * @private
     */
    __addTab: function (options) {
      if (!this.__hasDefaultRoute) {
        this.route('', options.method);
        this.__hasDefaultRoute = true;
      }

      _.each(options.routes, function (route) {
        this.route(route, options.method);
      }, this);
      var route = _.first(options.routes);
      this.__tabsWidget.addTab(_.extend(_.pick(options, 'label', 'method'), {route: route, router: this}));
    }

  });
});
