/**
 * Makes requests to legacy controllers so they can be used in backbone code.
 */
define(['underscore', 'backbone'], function (_, Backbone) {
    // add a converter mapping to remove the security prefix from json responses 
  Backbone.$.ajaxSetup({
    converters : {
      'text secureJSON' : function (str) {
        if (str.substring(0, 11) === 'while(1){};') {
          str = str.substring(11);
        }
        return JSON.parse(str);
      }
    }
  });
  return {
    post : function (config) {
      var options = _.clone(config);
      options.method = 'POST';
      options.dataType = 'secureJSON';
      options.headers = {
        'X-Okta-XsrfToken' : config.xsrfToken
      };
      var data = config.data;
      if (data && data.toJSON) {
        options.data = data.toJSON();
      }
      return Backbone.ajax(options);
    },

    get : function (config) {
      var options = _.clone(config);
      options.method = 'GET';
      options.dataType = 'secureJSON';
      var data = config.data;
      if (data && data.toJSON) {
        options.data = data.toJSON();
      }
      return Backbone.ajax(options);
    }
  };
});
