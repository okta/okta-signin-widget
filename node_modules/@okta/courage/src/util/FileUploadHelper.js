/* eslint max-statements: [2, 17] */
define(['underscore', 'jquery'],
  function (_, $) {
    return {

      // Prevent submit event from bubbling up to outer forms in all browsers.
      preventSubmit: function (e) {
        e.stopImmediatePropagation();
      },

      cloneAndSubmit: function (view, fileSelector, displaySelector) {
        // Get current form
        var id = view.cid + 'body-form-id';
        var cloneSelector = '#' + id;
        var generatedForm = $(cloneSelector);
        var form;
        if (generatedForm.length) {
          form = generatedForm;
        } else {
          form = view.$el;
        }

        // Clone current form
        var theClonedForm = form.clone(true).attr('id', id);
        form.replaceWith(theClonedForm);
        form.css('display: none');

        // Listen and change the label for changed file input
        var generated = $(cloneSelector);
        var fileInput = generated.find(fileSelector);
        fileInput.one('change', _.bind(function () {
          generated.find(displaySelector).val(fileInput.val());
        }, view));

        // Submit and remove cloned form
        $('body').append(form);
        form.submit().remove();

        return generated;
      }

    };
  }
);
