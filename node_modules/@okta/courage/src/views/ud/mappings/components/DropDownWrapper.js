define([
  'underscore',
  'jquery',
  'shared/views/BaseView',
  'shared/util/ProfileMappingPushStatus',
  './MappingDropDown'
], function (_, $, BaseView, ProfileMappingPushStatus, MappingDropDown) {

  $(document).click(function (e) {
    // Close the dropdown if we click anywhere outside the dropdown
    var isDropdown = $(e.target).hasClass('option-selected') && $(e.target).closest('.dropdown').length > 0;
    if (!isDropdown) {
      $('#ud-attribute-mapping-modal .dropdown .options').hide();
    }
  });

  return BaseView.extend({
    id: function () {
      return 'mapping_dropdown_' + this.options.idx;
    },

    events: {
      'click a.option-selected': function (e) {
        e.preventDefault();
        e.stopPropagation();
        this.$('div.options').toggle();
      }
    },

    modelEvents: {
      'change:pushStatus': 'render'
    },

    render: function () {
      this.empty();
      BaseView.prototype.render.apply(this, arguments);

      var mappingDropDown = new MappingDropDown({
        model: this.model,
        state: this.state,
        appModel: this.options.appModel
      });

      var pushStatus = this.model.get('pushStatus');
      _.extend(mappingDropDown, {
        icon: ProfileMappingPushStatus.getIconClass(pushStatus),
        className: ProfileMappingPushStatus.getDropDownWrapperClass(pushStatus)
      });

      this.add(mappingDropDown);

      return this;
    }
  });

});
