define([
  'jquery',
  'underscore',
  'shared/views/BaseView',
  'shared/views/forms/BaseForm',
  'shared/util/Logger',
  './WizardProgressBar',
  './WizardStateMachine',
  './WizardHelper',
  './WizardStepTitle',
  './WizardButtonBar',
  './WizardContent'
],
function ($, _, BaseView, BaseForm, Logger, WizardProgressBar, WizardStateMachine, WizardHelper, WizardStepTitle,
          WizardButtonBar, WizardContent) {
  /*eslint max-params: 0 */

  function isAutoSaveForm(form) {
    return isForm(form) && form.getAttribute('autoSave');
  }

  function isForm(form) {
    return form instanceof BaseForm;
  }

  function submitForm(form) {
    var d = $.Deferred();
    form.listenToOnce(form, 'saved', _.bind(d.resolveWith, d, form));
    form.listenTo(form, 'error', _.bind(d.rejectWith, d, form));
    form.$el.trigger('submit');
    return d.promise();
  }

  function clearForm(wizard) {
    var form = wizard.getCurrentView();
    if (isForm(form)) {
      form.model.trigger('form:cancel');
      wizard.wizardState.set('error', false);
    }
  }

  return BaseView.extend({

    /**
     * @class Okta.Wizard
     * @extends {Okta.View}
     *
     * A wizard component
     *
     *
     * ```javascript
     * var Wizard = Okta.Wizard.extend({
     *   title: 'My Wizard',
     *   steps: [
     *     {
     *       title: 'Step 1',
     *       view: Okta.View.extend({
     *         // Define a next function to tell the wizard what to do before proceeding to the next step.
     *         // if no next method is defined, the wizard will just move to the next step.
     *         next: function () {
     *           return model.save(); // returns a promise
     *         }
     *       });
     *     },
     *     {
     *       substep: true,
     *       title: 'Step 1.1 (substep)',
     *       view: Okta.View.extend()
     *     },
     *     {
     *       title: 'Step 2',
     *       // Shorthand for forms - if autosave is true,
     *       // the wizard will automatically proceed to the next step on successful form save.
     *       form: {
     *         autoSave: true,
     *         inputs: [
     *            {
     *              type: 'text',
     *              name: 'some-input',
     *              label: 'Form Input'
     *            }
     *         ]
     *       }
     *     }
     *   ]
     * });
     * ```
     */

    /**
     * Steps of the wizard
     *
     * ```javascript
     * var Wizard = Okta.Wizard.extend({
     *   steps: [
     *     {
     *       title: 'Step 1',
     *       view: Okta.View.extend({
     *         next: function () {
     *           return model.save(); // returns a promise
     *         }
     *       });
     *     },
     *     {
     *       substep: true,
     *       title: 'Step 1.1 (substep)',
     *       view: Okta.View.extend()
     *     },
     *     {
     *       title: 'Step 2',
     *       form: {
     *         autoSave: true,
     *         inputs: [
     *            {
     *              type: 'text',
     *              name: 'some-input',
     *              label: 'Form Input'
     *            }
     *         ]
     *       }
     *     }
     *   ]
     * });
     * ```
     *
     *  @type {Array|Function}
     */
    steps: [],

    /**
     * Title of the wizard. could be a string, a view or HTML
     * @type {String|Okta.View}
     */
    title: null,

    /**
     * The text for the save (done) button
     * @type {String|Function}
     */
    save: null,

    template: '\
      <h1 class="o-wizard-title"></h1>\
      <div class="o-wizard-progressbar-wrap">\
        <div class="o-wizard-progressbar-line"></div>\
      </div>\
      <div class="o-wizard-step-title"></div>\
      <div class="o-wizard-step-content"></div>\
      <div class="o-wizard-button-bar"></div>\
    ',

    getCurrentView: function () {
      return this.find(function (view) {
        return view instanceof WizardContent;
      }).first();
    },

    __goToNextStep: function () {
      var promise,
          state = this.wizardState,
          currentView = this.getCurrentView();

      if (isAutoSaveForm(currentView)) {
        promise = submitForm(currentView);
      }
      else if (_.isFunction(currentView.next)) {
        promise = currentView.next();
      }

      return $.when(promise)
        .then(_.bind(state.nextStep, state))
        .done(function () {
          state.set('error', false);
          state.trigger('wizard:sync');
        })
        .fail(function () {
          state.set('error', true);
          state.trigger('wizard:error');
        })
        .always(function () {
          Logger.log(JSON.stringify(state));
        });
    },

    __goToPrevStep: function (state) {
      // mark the curent step as not done;
      clearForm(this);
      state.prevStep();

      Logger.log(JSON.stringify(state));
      // mark the prev one as pending
    },

    __init: function () {
      /* eslint max-statements: 0 */
      this.wizardState = this.options.wizardState = new WizardStateMachine(null, {
        steps: _.result(this, 'steps')
      });

      this.$el.addClass('o-wizard o-wizard-progressbar-steps-' + this.wizardState.getMajorSteps().length);

      this.options.save = _.result(this, 'save');

      WizardHelper.addIf(this, 'title', '.o-wizard-title');
      this.add(WizardProgressBar, '.o-wizard-progressbar-wrap');
      this.add(WizardStepTitle, '.o-wizard-step-title');
      this.add(WizardContent, '.o-wizard-step-content');
      this.add(WizardButtonBar, '.o-wizard-button-bar');

      this.listenTo(this.wizardState, 'wizard:prev', function () {
        this.__goToPrevStep(this.wizardState);
      });

      this.listenTo(this.wizardState, 'wizard:next', function () {
        this.__goToNextStep();
      });

      this.listenTo(this.wizardState, 'wizard:done', this.done);
      this.listenTo(this.wizardState, 'wizard:cancel', function () {
        clearForm(this);
        this.cancel();
      });

    },

    constructor: function () {
      this.initialize = _.wrap(this.initialize, _.bind(function (initialize, options) {
        this.__init();
        initialize.call(this, options);
      }, this));

      BaseView.apply(this, arguments);
    },

    /**
     * A callback to execute when the wizard is completed
     * @type {Function}
     */
    done: _.noop,

    /**
     * A callback to execute when the wizard is canceled
     * @type {Function}
     */
    cancel: _.noop

  });

});
