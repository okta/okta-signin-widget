// get-okta-properties
//
// Gets extra properties we want to store in package.json:
// - commitSha
// - fullVersion
// - testedSha (if it exists in the commit message)
//
/* global module */
var git    = require('git-rev-sync'),
    logger = require('winston'),
    moment = require('moment');

function getFullVersion(version) {
  var currentDate = moment().format('YYYYMMDDHHmmss'),
      fullVersion = version + '-' + currentDate + '-' + git.short();
  return fullVersion;
}

// Finds tested sha from commit message - this is automatically generated by
// bacon when the topic branch is merged into master.
function getTestedSha() {
  var match = git.message().match(/Tested SHA: (\w+)/i);
  if (match) {
    logger.log('info', 'getTestedSha: Found sha', {
      testedSha: match[1]
    });
    return match[1];
  }
  logger.log('info', 'getTestedSha: No sha found');
  return null;
}

function getOktaProperties(version) {
  var props = {},
      testedSha;

  props.commitSha = git.long();
  props.fullVersion = getFullVersion(version);

  testedSha = getTestedSha();
  if (testedSha) {
    props.testedSha = testedSha;
  }

  logger.log('info', 'getOktaProperties:', props);
  return props;
}

module.exports = getOktaProperties;
