#!/usr/bin/env node

var program       = require('commander'),
    colors        = require('colors'),
    logger        = require('winston'),
    jsonfile      = require('jsonfile'),
    _             = require('lodash'),
    getProperties = require('../lib/get-properties');

// Using process.cwd to look up appRoot because we are modifying the caller's
// package.json, not our own.
var pkg = require(process.cwd() + '/package.json');

program
  .version(pkg.version)
  .usage('--branch <branch>')
  .option('-b, --branch <branch>', 'Target branch name')
  .option('-d, --dry-run', 'Dry run - does not write to package.json')
  .parse(process.argv);

if (!program.branch) {
  program.outputHelp(function (txt) {
    return colors.red(txt);
  });
  process.exit(1);
}

logger.log('info', 'Starting ci-update-package script');

logger.log('info', 'Getting properties to update', {
  pkgName: pkg.name,
  pkgVersion: pkg.version,
  branch: program.branch
});
var props = getProperties(pkg.name, pkg.version, program.branch);

if (program.dryRun) {
  logger.log('info', 'Dry run - would have written these properties', props);
}
else {
  logger.log('info', 'Writing properties to package.json', props);
  jsonfile.writeFileSync('package.json', _.extend(pkg, props), { spaces: 2 });
}

logger.log('info', 'Done');
